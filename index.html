<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>RRM-FT Assistant â€” FSMA 204 (FR/EN)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <style>
    :root{--bg:#0b0c10;--panel:#151820;--muted:#8ea0b3;--text:#eaf2f8;--acc:#37b24d;--warn:#f59f00;--err:#fa5252}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    .card{background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2);margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 320px}
    select,input,button{width:100%;padding:10px;border:1px solid #2a2f3a;background:#0f1320;color:var(--text);border-radius:10px}
    button{cursor:pointer}
    .pill{display:inline-block;padding:.15rem .55rem;border-radius:999px;font-weight:600}
    .ok{background:rgba(55,178,77,.15);color:var(--acc);border:1px solid rgba(55,178,77,.4)}
    .bad{background:rgba(250,82,82,.12);color:var(--err);border:1px solid rgba(250,82,82,.35)}
    .warn{background:rgba(245,159,0,.12);color:var(--warn);border:1px solid rgba(245,159,0,.35)}
    small.muted{color:var(--muted)} .right{margin-left:auto}.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    table{width:100%;border-collapse:collapse} th,td{padding:8px 10px;border-bottom:1px solid #2a2f3a;text-align:left}
    th{background:#101524;position:sticky;top:0;z-index:1}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .hidden{display:none}.mt8{margin-top:8px}.mt16{margin-top:16px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>RRM-FT Assistant â€” FSMA 204 <small class="muted">web-only</small></h1>
    <div style="display:flex;gap:8px">
      <select id="lang"><option value="fr">FranÃ§ais (UI)</option><option value="en">English (UI)</option></select>
      <button id="exportEN" title="Exporter les rÃ©sultats en anglais">Export EN (CSV)</button>
    </div>
  </header>

  <section class="card">
    <div class="row">
      <div class="col">
        <label>Sources FDA + intÃ©gritÃ©</label>
        <div class="mono" style="display:flex;gap:10px;align-items:center">
          <span id="statusBadge" class="pill warn">loadingâ€¦</span>
          <small id="counts" class="muted right">â€“</small>
        </div>
        <small class="muted">Lâ€™app charge 2A/1A/2B depuis le repo â†’ vÃ©rifie SHA-256 si <code>manifest.json</code> / <code>metadata/checksums.json</code> sont prÃ©sents. Aucune note nâ€™est recalculÃ©e.</small>
      </div>
      <div class="col">
        <label>Recherche / sÃ©lection denrÃ©e</label>
        <div style="display:flex;gap:8px">
          <input id="q" placeholder="Rechercher (FR/EN)"/>
          <select id="commoditySelect"></select>
        </div>
        <div class="mt8" style="display:flex;gap:8px;align-items:center">
          <span id="ftlBadge" class="pill hidden">FTL</span>
          <span id="aggScore" class="mono"></span>
          <small id="catName" class="muted right"></small>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;align-items:center">
      <h3 style="margin:0">Pairs danger (C1..C7 â†’ score)</h3>
      <small class="muted right">MÃ©thode & critÃ¨res : FDA RRM-FT</small>
    </div>
    <div style="max-height:420px;overflow:auto;margin-top:6px">
      <table id="pairsTable">
        <thead><tr><th>Hazard</th><th>C1</th><th>C2</th><th>C3</th><th>C4</th><th>C5</th><th>C6</th><th>C7</th><th>Score</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0">Projet dâ€™analyse (.RRM)</h3>
    <div class="grid mt8">
      <div><label>Nom</label><input id="projName" placeholder="Ex. Analyse â€” Tomates RTE"></div>
      <div><label>RÃ©f./Client</label><input id="projRef" placeholder="Ex. CN-2025-001 / Client X"></div>
      <div><label>Notes</label><input id="projNotes" placeholder="Contexte, sites, etc."></div>
      <div><label>PiÃ¨ces jointes</label><input id="files" type="file" multiple></div>
    </div>
    <div class="row mt16">
      <div class="col"><button id="saveRRM">ðŸ’¾ Enregistrer (.RRM)</button></div>
      <div class="col"><label>Charger .RRM</label><input id="openRRM" type="file" accept=".rrm,.zip"></div>
    </div>
    <div class="mt16"><label>Journal</label><div id="log" class="mono" style="background:#0f1320;border-radius:8px;padding:10px;min-height:80px;max-height:180px;overflow:auto"></div></div>
  </section>

  <section class="card">
    <details>
      <summary><strong>RÃ©fÃ©rences FDA</strong></summary>
      <ul>
        <li>RRM-FT â€” Results (Tables 2A/2B) â€” PDF : <a href="https://www.fda.gov/media/166880/download" target="_blank" rel="noopener">FDA</a></li>
        <li>RRM-FT web tool (exports : aggregatedAll / aggregatedFTL / pairsAll / pairsFTL)</li>
        <li>Food Traceability List : <a href="https://cfsanappsexternal.fda.gov/scripts/FDARiskRankingModelforFoodTracingfinalrule/" target="_blank" rel="noopener">FDA</a></li>
        <li>CTE/KDE â€” FSMA 204 : <a href="https://www.fda.gov/media/163132/download" target="_blank" rel="noopener">FDA</a></li>
      </ul>
    </details>
  </section>
</div>

<script>
/* ========= Helpers robustes (chemins, SHA, i18n) ========= */
const $ = s => document.querySelector(s);
const $tb = s => document.querySelector(s).tBodies[0];
const state = {
  manifest: null, checksums: null, cache: new Map(),
  twoA: null, oneA: null, i18n: {category:{}, commodity:{}, hazard:{}},
  lang: "fr", log: [], current: {category:null, commodity:null, pairs:[]},
  paths: { // essaie en/ puis racine
    twoA: ["en/commodities_table_2A.json","commodities_table_2A.json"],
    oneA: ["en/ftl_table_1A.json","ftl_table_1A.json"],
    manifest: ["manifest.json"],
    checks: ["metadata/checksums.json","checksums.json"],
    pairs: (cat,com) => [
      `en/pairs_table_2B/${slugify(cat)}__${slugify(com)}.json`,
      `pairs_table_2B/${slugify(cat)}__${slugify(com)}.json`
    ],
    i18nFR: ["i18n/fr_map.json"]
  }
};
const log = msg => {
  const t = new Date().toISOString();
  state.log.push({t,msg});
  $("#log").textContent = ( $("#log").textContent ? $("#log").textContent+"\n" : "" ) + `[${t}] ${msg}`;
};
const toHex = ab => [...new Uint8Array(ab)].map(b=>b.toString(16).padStart(2,"0")).join("");
async function sha256(ab){ return toHex(await crypto.subtle.digest("SHA-256", ab)); }
function slugify(s){ return String(s).replaceAll("&","and").normalize("NFKD").replace(/[^\x00-\x7F]/g,"").replace(/[^a-zA-Z0-9]+/g,"_").replace(/^_+|_+$/g,"").toLowerCase().slice(0,120); }
function cleanLabel(s){ return String(s||"").replace(/^\s*(\*|<\\?ast>|\\\*<\/ast>|<\/?ast>)+\s*/i,"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim(); }

async function fetchAB(path){
  const r = await fetch(path,{cache:"no-store"});
  if(!r.ok) throw new Error(`${path} -> HTTP ${r.status}`);
  return await r.arrayBuffer();
}
async function fetchJSON(path){
  const ab = await fetchAB(path);
  let json=null; try{ json = JSON.parse(new TextDecoder().decode(ab)); }catch{}
  return {json, ab};
}
async function fetchFirst(paths){ // essaie en cascade
  let lastErr;
  for(const p of paths){
    try{ const r = await fetchJSON(p); return {...r, path:p}; }catch(e){ lastErr=e; }
  }
  throw lastErr || new Error("Aucun chemin accessible: "+paths.join(", "));
}

/* ========= Chargement + intÃ©gritÃ© ========= */
async function loadAll(){
  $("#statusBadge").textContent="loadingâ€¦"; $("#statusBadge").className="pill warn";
  // manifest (facultatif mais prÃ©fÃ©rable)
  try{ state.manifest = (await fetchFirst(state.paths.manifest)).json; }catch{ state.manifest = null; }
  // checksums (facultatif)
  try{ state.checksums = (await fetchFirst(state.paths.checks)).json; }catch{ state.checksums = null; }

  // 2A / 1A
  const twoAres = await fetchFirst(state.paths.twoA);
  const oneAres = await fetchFirst(state.paths.oneA);
  await verifyIfPossible(twoAres.path, twoAres.ab);
  await verifyIfPossible(oneAres.path, oneAres.ab);
  state.twoA = twoAres.json; state.oneA = oneAres.json;

  // i18n FR (optionnel)
  try{
    const fr = await fetchFirst(state.paths.i18nFR);
    state.i18n = fr.json || state.i18n;
  }catch{}

  // compteurs
  const n2A = state.twoA?.commodities?.length || 0;
  const n1A = state.oneA?.items?.length || 0;
  const n2B = (state.manifest?.sources||[]).filter(s=>String(s.path||"").includes("pairs_table_2B/")).length
           || "n/a";
  $("#counts").textContent = `${n1A} FTL â€¢ ${n2A} commodities â€¢ ${n2B} files 2B`;

  $("#statusBadge").textContent = "intÃ©gritÃ© OK (si manifest/checksums prÃ©sents)";
  $("#statusBadge").className = "pill ok";

  populateCommodities();
  log("DonnÃ©es FDA chargÃ©es.");
}

async function verifyIfPossible(path, ab){
  // compare hash au manifest/checksums si prÃ©sence; sinon ne bloque pas
  const digest = await sha256(ab);
  const fromManifest = state.manifest?.sources?.find(s=>s.path===path)?.sha256;
  const fromChecks = state.checksums?.[path];
  if(fromManifest && fromManifest!==digest) throw new Error(`SHA mismatch manifest for ${path}`);
  if(fromChecks && fromChecks!==digest) throw new Error(`SHA mismatch checksums for ${path}`);
  state.cache.set(path,{ab,sha256:digest});
}

/* ========= FR/EN (UI + mapping facultatif) ========= */
const tCat = en => state.lang==="fr" ? (state.i18n.category?.[en]||en) : en;
const tCom = en => state.lang==="fr" ? (state.i18n.commodity?.[en]||en) : en;
const tHaz = en => state.lang==="fr" ? (state.i18n.hazard?.[en]||en) : en;

/* ========= Liste denrÃ©es ========= */
function populateCommodities(){
  const sel = $("#commoditySelect"); const q = ($("#q").value||"").toLowerCase();
  const items = (state.twoA?.commodities||[])
    .filter(r => !q || [r.commodity,r.category].some(x=>x.toLowerCase().includes(q)))
    .sort((a,b)=>a.commodity.localeCompare(b.commodity));
  sel.innerHTML="";
  for(const r of items){
    const o = document.createElement("option");
    o.value = JSON.stringify([r.category,r.commodity]);
    o.textContent = `${tCom(r.commodity)}${r.onFTL?" [FTL]":""} â€” ${tCat(r.category)}`;
    sel.appendChild(o);
  }
  if(items.length){ sel.selectedIndex=0; onCommodityChange(); }
}

/* ========= Chargement 2B pour une denrÃ©e ========= */
async function onCommodityChange(){
  const v = $("#commoditySelect").value; if(!v) return;
  const [category,commodity] = JSON.parse(v);
  state.current.category = category; state.current.commodity = commodity;

  const pairPaths = state.paths.pairs(category,commodity);
  const res = await fetchFirst(pairPaths); // essaye en/ puis racine
  await verifyIfPossible(res.path, res.ab);
  const data = res.json || {};
  state.current.pairs = data.pairs || [];

  const r2a = state.twoA.commodities.find(r=>r.category===category && r.commodity===commodity);
  $("#ftlBadge").className = `pill ${r2a?.onFTL?"ok": "hidden"}`; $("#ftlBadge").textContent = r2a?.onFTL?"FTL":"";
  $("#aggScore").textContent = r2a ? `score agrÃ©gÃ©: ${r2a.riskScoreCommodity}` : "";
  $("#catName").textContent = `${tCat(category)} â€¢ ${tCom(commodity)}`;

  renderPairs();
  log(`Ouverture denrÃ©e: ${category} â€” ${commodity}`);
}

function renderPairs(){
  const tb = $tb("#pairsTable"); tb.innerHTML="";
  for(const p of state.current.pairs){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${tHaz(p.hazard)}</td>
      <td>${p.C1}</td><td>${p.C2}</td><td>${p.C3}</td><td>${p.C4}</td><td>${p.C5}</td><td>${p.C6}</td><td>${p.C7}</td>
      <td class="mono">${p.riskScorePair}</td>`;
    tb.appendChild(tr);
  }
}

/* ========= Projets .RRM ========= */
async function saveRRM(){
  if(!state.current.category) { alert("Choisis dâ€™abord une denrÃ©e."); return; }
  const zip = new JSZip();
  const proj = {
    schemaVersion:"rrmft-project-1.0", savedAt:new Date().toISOString(), uiLang:state.lang,
    selection:{category:state.current.category, commodity:state.current.commodity},
    results: state.current.pairs,
    notes:{name:$("#projName").value, ref:$("#projRef").value, notes:$("#projNotes").value},
    log: state.log
  };
  zip.file("project.json", JSON.stringify(proj, null, 2));
  const files = $("#files").files;
  for(let i=0;i<files.length;i++){ zip.file("attachments/"+files[i].name, await files[i].arrayBuffer()); }
  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${slugify($("#projName").value||state.current.commodity)||"rrmft"}.rrm`;
  a.click(); URL.revokeObjectURL(a.href);
  log("Projet sauvegardÃ© (.RRM).");
}
async function openRRM(ev){
  const f = ev.target.files?.[0]; if(!f) return;
  const zip = await JSZip.loadAsync(await f.arrayBuffer());
  const proj = JSON.parse(await zip.file("project.json").async("string"));
  state.lang = proj.uiLang || "fr"; $("#lang").value = state.lang;
  $("#projName").value = proj?.notes?.name||""; $("#projRef").value=proj?.notes?.ref||""; $("#projNotes").value=proj?.notes?.notes||"";
  state.log = proj?.log || [];
  if(proj?.selection?.category && proj?.selection?.commodity){
    $("#q").value=""; populateCommodities();
    $("#commoditySelect").value = JSON.stringify([proj.selection.category, proj.selection.commodity]);
    await onCommodityChange();
  }
  log("Projet chargÃ© (.RRM).");
}

/* ========= Export EN (CSV) ========= */
function exportEN(){
  const pairs = state.current.pairs||[];
  const L = [["Category","Commodity","Hazard","C1","C2","C3","C4","C5","C6","C7","PairRisk"]];
  for(const p of pairs){ L.push([state.current.category, state.current.commodity, p.hazard, p.C1,p.C2,p.C3,p.C4,p.C5,p.C6,p.C7,p.riskScorePair]); }
  const csv = L.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
  a.download = `${slugify(state.current.commodity||"export")}_EN.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* ========= Ã‰vÃ©nements UI ========= */
$("#lang").addEventListener("change", ()=>{ state.lang=$("#lang").value; populateCommodities(); renderPairs(); });
$("#q").addEventListener("input", populateCommodities);
$("#commoditySelect").addEventListener("change", onCommodityChange);
$("#saveRRM").addEventListener("click", saveRRM);
$("#openRRM").addEventListener("change", openRRM);
$("#exportEN").addEventListener("click", exportEN);

/* ========= GO ========= */
loadAll().catch(err=>{
  $("#statusBadge").className="pill bad";
  $("#statusBadge").textContent="erreur chargement";
  log("ERREUR: "+(err?.message||err));
  alert("Erreur de chargement des donnÃ©es FDA.\nDÃ©tail:\n"+(err?.message||err)+"\n\nVÃ©rifie les chemins (en/â€¦ vs racine) et le manifest.");
});
</script>
</body>
</html>
