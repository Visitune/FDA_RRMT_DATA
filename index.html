<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDA RRM-FT Assistant - GitHub Version</title>
    <link rel="stylesheet" href="css/styles.css">
    <meta name="description" content="FDA Risk Ranking Model for Food Tracing - FSMA 204 Rule">
</head>
<body>
    <header>
        <h1>FDA RRM-FT Assistant</h1>
        <p>Risk Ranking Model for Food Tracing (FSMA 204 Rule)</p>
    </header>

    <main>
        <div class="controls">
            <select id="lang">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
            </select>
            
            <select id="commoditySelect">
                <option value="">Select a commodity...</option>
            </select>
            
            <input type="search" id="q" placeholder="Search commodities..." aria-label="Search">
            
            <span id="statusBadge" class="pill">Loading...</span>
            <span id="counts"></span>
        </div>

        <div class="results">
            <div class="summary">
                <span id="ftlBadge" class="pill hidden">FTL</span>
                <span id="catName"></span>
                <span id="aggScore"></span>
            </div>

            <table id="pairsTable">
                <thead>
                    <tr>
                        <th>Hazard</th>
                        <th>C1</th>
                        <th>C2</th>
                        <th>C3</th>
                        <th>C4</th>
                        <th>C5</th>
                        <th>C6</th>
                        <th>C7</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="project">
            <h3>Project Management</h3>
            <input type="text" id="projName" placeholder="Project name">
            <input type="text" id="projRef" placeholder="Reference">
            <textarea id="projNotes" placeholder="Notes"></textarea>
            <input type="file" id="files" multiple>
            <button id="saveRRM">Save .RRM</button>
            <input type="file" id="openRRM" accept=".rrm" style="display: none;">
            <button onclick="document.getElementById('openRRM').click()">Open .RRM</button>
        </div>

        <div class="log">
            <h3>Activity Log</h3>
            <pre id="log"></pre>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // GitHub-compatible version
        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/YOUR_USERNAME/fda-rrmft-data/main/';
        
        class RRMFTApp {
            constructor() {
                this.state = {
                    lang: 'fr',
                    data: { oneA: null, twoA: null, i18n: { hazard: {}, commodity: {}, category: {} } },
                    current: { commodity: null, category: null, pairs: null },
                    log: []
                };
                this.init();
            }

            async init() {
                this.cacheElements();
                this.bindEvents();
                await this.loadData();
            }

            cacheElements() {
                this.elements = {
                    langSelect: document.getElementById('lang'),
                    commoditySelect: document.getElementById('commoditySelect'),
                    searchInput: document.getElementById('q'),
                    statusBadge: document.getElementById('statusBadge'),
                    counts: document.getElementById('counts'),
                    ftlBadge: document.getElementById('ftlBadge'),
                    aggScore: document.getElementById('aggScore'),
                    catName: document.getElementById('catName'),
                    pairsTable: document.getElementById('pairsTable'),
                    projName: document.getElementById('projName'),
                    projRef: document.getElementById('projRef'),
                    projNotes: document.getElementById('projNotes'),
                    filesInput: document.getElementById('files'),
                    saveRRM: document.getElementById('saveRRM'),
                    openRRM: document.getElementById('openRRM'),
                    log: document.getElementById('log')
                };
            }

            bindEvents() {
                this.elements.langSelect.addEventListener('change', (e) => {
                    this.setLanguage(e.target.value);
                });

                this.elements.commoditySelect.addEventListener('change', (e) => {
                    this.selectCommodity(e.target.value);
                });

                this.elements.searchInput.addEventListener('input', this.debounce((e) => {
                    this.handleSearch(e.target.value);
                }, 300));

                this.elements.saveRRM.addEventListener('click', () => this.saveProject());
                this.elements.openRRM.addEventListener('change', (e) => {
                    if (e.target.files[0]) this.loadProject(e.target.files[0]);
                });
            }

            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            async fetchData(path) {
                try {
                    const response = await fetch(GITHUB_BASE_URL + path);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    this.log(`Error loading ${path}: ${error.message}`, 'error');
                    throw error;
                }
            }

            async loadData() {
                try {
                    this.setLoading(true);
                    this.log('Loading FDA RRM-FT data from GitHub...');

                    const [twoA, oneA, hazardI18n, commodityI18n, categoryI18n] = await Promise.all([
                        this.fetchData('commodities_table_2A.json'),
                        this.fetchData('ftl_table_1A.json'),
                        this.fetchData('i18n/hazard.json'),
                        this.fetchData('i18n/commodity.json'),
                        this.fetchData('i18n/category.json')
                    ]);

                    this.state.data.twoA = twoA.data || twoA;
                    this.state.data.oneA = oneA.data || oneA;
                    this.state.data.i18n.hazard = hazardI18n;
                    this.state.data.i18n.commodity = commodityI18n;
                    this.state.data.i18n.category = categoryI18n;

                    this.updateDataStatus();
                    this.populateCommoditySelect();
                    this.log('Data loaded successfully from GitHub', 'success');

                } catch (error) {
                    this.log(`Critical error: ${error.message}`, 'error');
                    this.setStatus('error', 'Error loading data');
                } finally {
                    this.setLoading(false);
                }
            }

            setLoading(isLoading) {
                const badge = this.elements.statusBadge;
                badge.textContent = isLoading ? 'Loading...' : 'Ready';
                badge.className = isLoading ? 'pill warn' : 'pill ok';
            }

            setStatus(type, message) {
                this.elements.statusBadge.textContent = message;
                this.elements.statusBadge.className = `pill ${type}`;
            }

            updateDataStatus() {
                if (this.state.data.twoA && this.state.data.oneA) {
                    const totalCommodities = this.state.data.twoA.length || Object.keys(this.state.data.twoA).length;
                    this.elements.counts.textContent = `${totalCommodities} commodities`;
                }
            }

            populateCommoditySelect() {
                if (!this.state.data.twoA) return;

                const select = this.elements.commoditySelect;
                select.innerHTML = '<option value="">Select a commodity...</option>';

                const commodities = (Array.isArray(this.state.data.twoA) ? this.state.data.twoA : Object.values(this.state.data.twoA))
                    .map(item => ({
                        code: item.code,
                        name: this.state.data.i18n.commodity[item.code]?.[this.state.lang] || item.commodity || item.name
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name));

                commodities.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = `${item.name} (${item.code})`;
                    select.appendChild(option);
                });
            }

            setLanguage(lang) {
                this.state.lang = lang;
                this.populateCommoditySelect();
                if (this.state.current.commodity) {
                    this.selectCommodity(this.state.current.commodity);
                }
            }

            async selectCommodity(code) {
                if (!code) return;

                this.state.current.commodity = code;
                const commodity = this.state.data.twoA.find ? 
                    this.state.data.twoA.find(c => c.code === code) : 
                    this.state.data.twoA[code];

                if (!commodity) return;

                // Update UI
                const isFTL = this.state.data.oneA.find ? 
                    this.state.data.oneA.find(c => c.code === code)?.ftl : 
                    this.state.data.oneA[code]?.ftl;

                this.elements.ftlBadge.style.display = isFTL ? 'inline-block' : 'none';
                
                const catName = this.state.data.i18n.category[commodity.category]?.[this.state.lang] || 
                               commodity.category;
                this.elements.catName.textContent = catName;

                await this.loadPairs(code);
            }

            async loadPairs(code) {
                try {
                    const pairs = await this.fetchData(`pairs_table_2B/${code}.json`);
                    this.state.current.pairs = pairs;
                    this.displayPairs(pairs);
                    
                    const maxScore = Math.max(...Object.values(pairs).map(p => p.score || 0));
                    this.elements.aggScore.textContent = `Max score: ${maxScore}`;
                    
                } catch (error) {
                    this.log(`Error loading pairs: ${error.message}`, 'error');
                    this.displayPairs({});
                }
            }

            displayPairs(pairs) {
                const tbody = this.elements.pairsTable.querySelector('tbody');
                tbody.innerHTML = '';

                if (!pairs || Object.keys(pairs).length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = '<td colspan="9" style="text-align: center; padding: 32px;">No data available</td>';
                    tbody.appendChild(tr);
                    return;
                }

                Object.entries(pairs)
                    .sort(([, a], [, b]) => (b.score || 0) - (a.score || 0))
                    .forEach(([hazard, data]) => {
                        const tr = document.createElement('tr');
                        const hazardName = this.state.data.i18n.hazard[hazard]?.[this.state.lang] || hazard;
                        
                        tr.innerHTML = `
                            <th>${hazardName}</th>
                            <td>${data.c1 || 0}</td>
                            <td>${data.c2 || 0}</td>
                            <td>${data.c3 || 0}</td>
                            <td>${data.c4 || 0}</td>
                            <td>${data.c5 || 0}</td>
                            <td>${data.c6 || 0}</td>
                            <td>${data.c7 || 0}</td>
                            <td><strong>${data.score || 0}</strong></td>
                        `;
                        tbody.appendChild(tr);
                    });
            }

            handleSearch(query) {
                if (!query) return;

                const select = this.elements.commoditySelect;
                const options = Array.from(select.options);
                const lowercaseQuery = query.toLowerCase();

                const match = options.find(opt => 
                    opt.text.toLowerCase().includes(lowercaseQuery) ||
                    opt.value.toLowerCase().includes(lowercaseQuery)
                );

                if (match && match.value) {
                    select.value = match.value;
                    this.selectCommodity(match.value);
                }
            }

            async saveProject() {
                try {
                    const name = this.elements.projName.value.trim();
                    const ref = this.elements.projRef.value.trim();
                    const notes = this.elements.projNotes.value.trim();
                    
                    if (!this.state.current.commodity) {
                        alert('Please select a commodity first');
                        return;
                    }

                    const project = {
                        metadata: {
                            name: name || 'Untitled',
                            reference: ref || '',
                            notes: notes || '',
                            created: new Date().toISOString(),
                            version: '1.0'
                        },
                        analysis: {
                            commodity: this.state.current.commodity,
                            pairs: this.state.current.pairs
                        }
                    };

                    const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
                    const filename = `rrmft_${name || 'project'}_${new Date().toISOString().split('T')[0]}.rrm`;

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.log(`Project saved: ${filename}`, 'success');
                } catch (error) {
                    this.log(`Error saving project: ${error.message}`, 'error');
                }
            }

            async loadProject(file) {
                try {
                    const text = await file.text();
                    const project = JSON.parse(text);
                    
                    this.elements.projName.value = project.metadata.name || '';
                    this.elements.projRef.value = project.metadata.reference || '';
                    this.elements.projNotes.value = project.metadata.notes || '';
                    
                    if (project.analysis.commodity) {
                        this.selectCommodity(project.analysis.commodity);
                    }

                    this.log(`Project loaded: ${file.name}`, 'success');
                } catch (error) {
                    this.log(`Error loading project: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                this.elements.log.textContent += `[${timestamp}] ${message}\n`;
                this.elements.log.scrollTop = this.elements.log.scrollHeight;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            new RRMFTApp();
        });
    </script>
</body>
</html>